rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ==============================
    // stories 컬렉션
    // ==============================
    match /stories/{storyId} {
      allow read: if request.auth != null;

      // 조회수 증가
      allow update: if 
        request.auth != null &&
        isValidIncrement(request.resource.data, resource.data, 'viewCount') &&
        // Track의 조회수도 같이 올라가는지 확인
        isTrackSynced(resource.data.trackId, 'viewCount');
      
      // 좋아요 증가
      allow update: if 
        request.auth != null &&
        isValidIncrement(request.resource.data, resource.data, 'favoriteCount') &&
        // Track의 좋아요도 같이 올라가는지 확인
        isTrackSynced(resource.data.trackId, 'favoriteCount') &&
        // 좋아요 기록 문서가 생기는지 확인
        existsAfter(/databases/$(database)/documents/stories/$(storyId)/favorites/$(request.auth.uid));
    }

    // ==============================
    // stories favorites 서브컬렉션
    // ==============================
    match /stories/{storyId}/favorites/{userId} {
      allow read: if 
        request.auth != null &&
        request.auth.uid == userId;

      allow create: if 
        request.auth != null &&
        request.auth.uid == userId &&
        // 생성 시 스토리의 좋아요 수가 증가하는지 확인
        isStorySynced(storyId, 'favoriteCount');
    }

    // ==============================
    // tracks 컬렉션
    // ==============================
    match /tracks/{trackId} {
      allow read: if request.auth != null;

      // 조회수 증가
      allow update: if 
        request.auth != null &&
        isValidIncrement(request.resource.data, resource.data, 'viewCount');
      
      // 좋아요 증가
      allow update: if 
        request.auth != null &&
        isValidIncrement(request.resource.data, resource.data, 'favoriteCount');
    }

    // ==============================
    // 공통 함수
    // ==============================

    // 특정 stats 필드만 1 증가하는지 검증
    function isValidIncrement(newData, oldData, fieldName) {
      return newData.diff(oldData).affectedKeys().hasOnly(['stats']) &&
             newData.stats.diff(oldData.stats).affectedKeys().hasOnly([fieldName]) &&
             newData.stats[fieldName] == oldData.stats[fieldName] + 1;
    }

    // trackId에 해당하는 track 문서의 특정 stats 필드가 1 증가하는지 검증
    function isTrackSynced(trackId, fieldName) {
      let trackPath = /databases/$(database)/documents/tracks/$(trackId);
      let after = getAfter(trackPath);
      let before = get(trackPath);
      
      return after != null && before != null &&
             after.data.stats[fieldName] == before.data.stats[fieldName] + 1;
    }

    // storyId에 해당하는 story 문서의 특정 stats 필드가 1 증가하는지 검증
    function isStorySynced(storyId, fieldName) {
      let storyPath = /databases/$(database)/documents/stories/$(storyId);
      let after = getAfter(storyPath);
      let before = get(storyPath);

      return after != null && before != null &&
             after.data.stats[fieldName] == before.data.stats[fieldName] + 1;
    }
  }
}