rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ==============================
    // stories 컬렉션
    // ==============================
    match /stories/{storyId} {
      allow read: if request.auth != null;

      // 조회수 증가
      allow update: if 
        request.auth != null &&
        isValidIncrement(request.resource.data, resource.data, 'viewCount') &&
        // Track의 조회수도 같이 올라가는지 확인
        isTrackSynced(resource.data.trackId, 'viewCount');
      
      // 좋아요 증가
      allow update: if 
        request.auth != null &&
        isValidIncrement(request.resource.data, resource.data, 'favoriteCount') &&
        // Track의 좋아요도 같이 올라가는지 확인
        isTrackSynced(resource.data.trackId, 'favoriteCount') &&
        // 좋아요 문서가 새로 생성되었는지 확인
        existsAfter(/databases/$(database)/documents/stories/$(storyId)/favorites/$(request.auth.uid)) &&
        // 현재는 좋아요 문서가 없는지 확인
        !exists(/databases/$(database)/documents/stories/$(storyId)/favorites/$(request.auth.uid));
    }

    // ==============================
    // stories favorites 서브컬렉션
    // ==============================
    match /stories/{storyId}/favorites/{userId} {
      allow read: if 
        request.auth != null &&
        request.auth.uid == userId;

      allow create: if 
        request.auth != null &&
        request.auth.uid == userId &&
        // 생성 시 스토리의 좋아요 수가 증가하는지 확인
        isStorySynced(storyId, 'favoriteCount') &&
        // 좋아요 문서 스키마 검증
        isValidFavoriteSchema(request.resource.data, userId);
    }

    // ==============================
    // tracks 컬렉션
    // ==============================
    match /tracks/{trackId} {
      allow read: if request.auth != null;

      // 조회수 증가
      allow update: if 
        request.auth != null &&
        isValidIncrement(request.resource.data, resource.data, 'viewCount');
      
      // 좋아요 증가
      allow update: if 
        request.auth != null &&
        isValidIncrement(request.resource.data, resource.data, 'favoriteCount');
    }

    // ==============================
    // 공통 함수
    // ==============================

    // favorites 서브컬렉션의 문서 스키마 검증
    function isValidFavoriteSchema(data, userId) {
      return 
        data.keys().hasOnly(['userId', 'createdAt']) &&
        data.userId == userId &&
        data.createdAt == request.time;
    }

    // 특정 stats 필드만 1 증가하는지 검증
    function isValidIncrement(newData, oldData, fieldName) {
      return newData.diff(oldData).affectedKeys().hasOnly(['stats']) &&
            // stats 필드 내부의 변경사항이 해당 fieldName 하나뿐인지 확인 
            newData.stats.diff(oldData.stats).affectedKeys().hasOnly([fieldName]) &&
            // 타입이 숫자인지 확인
            (newData.stats[fieldName] is number) &&
            // 값이 1 증가했는지 확인
            newData.stats[fieldName] == oldData.stats[fieldName] + 1;
    }

    // trackId에 해당하는 track 문서의 특정 stats 필드가 1 증가하는지 검증
    function isTrackSynced(trackId, fieldName) {
      let trackPath = /databases/$(database)/documents/tracks/$(trackId);
      let after = getAfter(trackPath);
      let before = get(trackPath);
      
      return after != null && before != null &&
            // 타입이 숫자인지 확인
            (after.data.stats[fieldName] is number) &&
            // 값이 1 증가했는지 확인
            after.data.stats[fieldName] == before.data.stats[fieldName] + 1;
    }

    // storyId에 해당하는 story 문서의 특정 stats 필드가 1 증가하는지 검증
    function isStorySynced(storyId, fieldName) {
      let storyPath = /databases/$(database)/documents/stories/$(storyId);
      let after = getAfter(storyPath);
      let before = get(storyPath);

      return after != null && before != null &&
            // 타입이 숫자인지 확인
            (after.data.stats[fieldName] is number) &&
            // 값이 1 증가했는지 확인
            after.data.stats[fieldName] == before.data.stats[fieldName] + 1;
    }
  }
}