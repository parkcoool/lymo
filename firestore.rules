rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ==============================
    // stories ì»¬ë ‰ì…˜
    // ==============================
    match /stories/{storyId} {
      allow read: if request.auth != null;
      
      allow update: if 
        request.auth != null &&
        (
           isValidStatsIncrement(request.resource.data, resource.data, 'viewCount') ||
           isValidStatsIncrement(request.resource.data, resource.data, 'favoriteCount') ||
           isValidStatsDecrement(request.resource.data, resource.data, 'favoriteCount')
        );
    }

    // ==============================
    // stories favorites ì„œë¸Œì»¬ë ‰ì…˜
    // ==============================
    match /stories/{storyId}/favorites/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;

      allow create: if 
        request.auth != null &&
        request.auth.uid == userId &&
        isValidFavoriteDocSchema(request.resource.data, userId);

      allow delete: if
        request.auth != null &&
        request.auth.uid == userId;
    }

    // ==============================
    // stories reactions ì„œë¸Œì»¬ë ‰ì…˜
    // ==============================
    match /stories/{storyId}/reactions/{reactionId} {
      allow read: if request.auth != null;
      
      allow create: if
        request.auth != null &&
        request.resource.data.userId == request.auth.uid &&
        isValidReactionDocSchema(request.resource.data, request.auth.uid);

      allow delete: if 
        request.auth != null && 
        resource.data.userId == request.auth.uid;
    }

    // ==============================
    // stories buckets ì„œë¸Œì»¬ë ‰ì…˜
    // ==============================
    match /stories/{storyId}/buckets/{bucketId} {
      allow read: if request.auth != null;

      allow update: if
        request.auth != null &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['counts']) &&
        (request.resource.data.counts is map) &&
        isValidBucketKeys(request.resource.data.counts) &&
        isValidBucketCountIncrement(request.resource.data.counts, resource.data.counts);
    }

    // ==============================
    // tracks ì»¬ë ‰ì…˜
    // ==============================
    match /tracks/{trackId} {
      allow read: if request.auth != null;

      allow update: if 
        request.auth != null &&
        (
          isValidStatsIncrement(request.resource.data, resource.data, 'viewCount') ||
          isValidStatsIncrement(request.resource.data, resource.data, 'favoriteCount') ||
          isValidStatsDecrement(request.resource.data, resource.data, 'favoriteCount')
        );
    }

    // ==============================
    // í•¨ìˆ˜
    // ==============================

    function isValidFavoriteDocSchema(data, userId) {
      return 
        data.keys().hasOnly(['userId', 'createdAt']) &&
        data.userId == userId &&
        data.createdAt == request.time;
    }

    function isValidReactionDocSchema(data, userId) {
      return 
        data.userId == userId &&
        (data.timestampInSeconds is number) &&
        (data.createdAt is string) &&
        (
          (data.type == 'emoji' && isAllowedEmoji(data.content)) ||
          (data.type == 'comment' && (data.content is string) && data.content.size() > 0 && data.content.size() <= 300)
        );
    }

    function isAllowedEmoji(emoji) {
      return emoji in [
        "ðŸ”¥", "â¤ï¸", "ðŸ˜­", "ðŸ¤˜", "ðŸ¤£", "ðŸ‘", "ðŸ¥º", "ðŸ˜", 
        "ðŸ˜Ž", "ðŸ¤¯", "ðŸ’¯", "ðŸ’”", "ðŸ«¶", "âœ¨", "ðŸŒ™", "ðŸŽ‰", 
        "ðŸ¥°", "ðŸ’ƒ", "ðŸ¥€", "â˜ï¸", "ðŸ«¢", "ðŸ¤ª", "ðŸ‘»", "ðŸ·"
      ];
    }

    function isValidBucketKeys(countsMap) {
      return countsMap.keys().hasOnly([
        "ðŸ”¥", "â¤ï¸", "ðŸ˜­", "ðŸ¤˜", "ðŸ¤£", "ðŸ‘", "ðŸ¥º", "ðŸ˜", 
        "ðŸ˜Ž", "ðŸ¤¯", "ðŸ’¯", "ðŸ’”", "ðŸ«¶", "âœ¨", "ðŸŒ™", "ðŸŽ‰", 
        "ðŸ¥°", "ðŸ’ƒ", "ðŸ¥€", "â˜ï¸", "ðŸ«¢", "ðŸ¤ª", "ðŸ‘»", "ðŸ·",
        "comment" 
      ]);
    }

    function isValidBucketCountIncrement(newCounts, oldCounts) {
      return newCounts.diff(oldCounts).affectedKeys().size() == 1;
    }

    function isValidStatsIncrement(newData, oldData, fieldName) {
      return newData.diff(oldData).affectedKeys().hasOnly(['stats']) &&
             newData.stats.diff(oldData.stats).affectedKeys().hasOnly([fieldName]) &&
             (newData.stats[fieldName] is number) &&
             newData.stats[fieldName] == oldData.stats[fieldName] + 1;
    }

    function isValidStatsDecrement(newData, oldData, fieldName) {
      return newData.diff(oldData).affectedKeys().hasOnly(['stats']) &&
             newData.stats.diff(oldData.stats).affectedKeys().hasOnly([fieldName]) &&
             (newData.stats[fieldName] is number) &&
             newData.stats[fieldName] == oldData.stats[fieldName] - 1 &&
             newData.stats[fieldName] >= 0;
    }
  }
}